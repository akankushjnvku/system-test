# Copyright Yahoo. Licensed under the terms of the Apache 2.0 license. See LICENSE in the project root.

search hamming {
  document hamming {
    field order type int {
      indexing: attribute | summary
    }
    field title type string {
      indexing: index | summary
    }
    field docvector type tensor<int8>(x[16],sentence{}) {
      indexing: attribute
    }
  }
  rank-profile default {
    macro hamming_dist_x(a,b) {
      expression {
        reduce(hamming(a,b),sum,x)
      }
    }
    macro min_sentence_hamming_dist(a,b) {
      expression {
        reduce(hamming_dist_x(a,b),min,sentence)
      }
    }
    macro best_closeness(a,b) {
      expression {
        map(min_sentence_hamming_dist(a,b),f(x)(1/(1+x)))
      }
    }
    first-phase {
      expression {
        sum(best_closeness(query(qvector),attribute(docvector)))
      }
    }
    function output_tensor() {
      expression {
        best_closeness(query(qvector),attribute(docvector))
      }
    }
    summary-features: output_tensor
  }
}
